{"version":3,"sources":["../src/WFEnrolMailPreview.js"],"names":["define","$","notification","init","mailPreviewApiUrl","dialog","autoOpen","width","height","maxHeight","title","draggable","modal","resizable","closeOnEscape","closeText","buttons","text","id","click","length","submit","filesurls","filesRole","emailsLists","manualEmailsRole","groupsLists","csvGroupLists","manualGroupsLists","map","index","elt","group","find","push","join","matches","exec","attr","role","indexBis","eltLink","filter","val","loadingModal","position","color","opacity","backgroundColor","animation","post","urls","files_role","manual_emails","manual_emails_role","csv_groups_lists","manual_groups_lists","response","error","alert","html","show"],"mappings":"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","sourcesContent":["/* jshint ignore:start */\r\ndefine(['jquery', 'core/notification', 'jqueryui', 'local_workflow/jquery.loadingModal'], function($, notification) {\r\n    function init(mailPreviewApiUrl) {\r\n\r\n        $(\"#wf_dialog_preview_mails\").dialog({\r\n            autoOpen: false,\r\n            width: 700,\r\n            height: 'auto',\r\n            maxHeight: 470,\r\n            title: \"PrÃ©visualisation de l'inscription mail\",\r\n            draggable: \"false\",\r\n            modal: true,\r\n            resizable: false,\r\n            closeOnEscape: false,\r\n            closeText: 'Fermer',\r\n            buttons: [{\r\n                text: \"Valider\",\r\n                id: \"btValidateMails\",\r\n                click: function() {\r\n                    if ($('.mform').length) { // test if mform exist\r\n                        $('.mform')[0].submit();\r\n                    }\r\n                }\r\n            },\r\n                {\r\n                    text: \"Annuler\",\r\n                    id: \"btCancel\",\r\n                    click: function() {\r\n                        $(this).dialog(\"close\");\r\n                    }\r\n                }]\r\n        });\r\n\r\n        \r\n        $(\"#id_submitbutton\").click(function(e) {\r\n\r\n            var filesurls = [];\r\n            var filesRole = [];\r\n\r\n            var emailsLists = [];\r\n            var manualEmailsRole = [];\r\n\r\n            var groupsLists = [];\r\n            var csvGroupLists = [];\r\n            var manualGroupsLists = [];\r\n            \r\n\r\n            $(\"div[id^=fitem_id_][id$=_groups_user_enrol]\").map(function(index, elt) {\r\n                var group = [];\r\n                $(elt).find(\"select\").find(\":selected\").map(function(index, elt) {\r\n                    group.push($(elt).text());\r\n                });\r\n                groupsLists.push(group.join());\r\n            });\r\n\r\n\r\n            $(\"div[id^=fitem_id_][id$=_userfile]\").map(function(index, elt) {\r\n                var regexp = /fitem_id_(.*)_userfile/g; // get role with regexp\r\n                var matches = regexp.exec($(elt).attr('id'));\r\n                var role = matches[1];\r\n\r\n                $(elt).find(\".filepicker-filename\").find(\"a\").map(function(indexBis, eltLink) {\r\n                    filesurls.push($(eltLink).attr('href'));\r\n                    filesRole.push(role); // add role linked to this file\r\n                    csvGroupLists.push(groupsLists[index]);\r\n                });\r\n \r\n            });\r\n\r\n            $(\"div[id^=fitem_id_][id$=_email_user_enrol]\").map(function(index, elt) {\r\n                var regexp = /fitem_id_(.*)_email_user_enrol/g;\r\n                var matches = regexp.exec($(elt).attr('id'));\r\n                var role = matches[1];\r\n                $(elt).find(\"textarea\").filter(function(indexBis,elt){\r\n                    return $(elt).val() != \"\";\r\n                }).map(function(indexBis, elt) {\r\n                    emailsLists.push($(elt).val());\r\n                    manualEmailsRole.push(role);\r\n                    manualGroupsLists.push(groupsLists[index]);\r\n                });\r\n            });\r\n\r\n            \r\n            if ((filesurls && filesurls.length > 0) || (emailsLists && emailsLists.length > 0)) {\r\n                $(\"body\").loadingModal({\r\n                    position: \"auto\",\r\n                    text: \"Validation des emails en cours...\",\r\n                    color: \"#fff\",\r\n                    opacity: \"0.7\",\r\n                    backgroundColor: \"rgb(0,0,0)\",\r\n                    animation: \"circle\"\r\n                });\r\n\r\n                $.post(\r\n                    mailPreviewApiUrl,\r\n                    {\r\n                        urls: filesurls,\r\n                        files_role: filesRole,\r\n                        manual_emails: emailsLists,\r\n                        manual_emails_role: manualEmailsRole,\r\n                        csv_groups_lists: csvGroupLists,\r\n                        manual_groups_lists: manualGroupsLists,\r\n                    },\r\n                    function(response) {\r\n                        if (response.error==\"false\") {\r\n                            notification.alert('Erreur', 'Erreur de communication avec le serveur.', 'Retour');\r\n                        } else {\r\n                            var table = response;\r\n                            $('#wf_dialog_preview_mails').html(table);\r\n                            $('#wf_dialog_preview_mails').show();\r\n                            $('#wf_dialog_preview_mails').dialog('open');\r\n                        }\r\n                        $(\"body\").loadingModal(\"destroy\");\r\n                    },\r\n                    \"html\"\r\n                );\r\n            } else {\r\n                if ($('.mform').length) { // test if mform exist\r\n                    $('.mform')[0].submit();\r\n                }\r\n            }\r\n            \r\n        });\r\n    }\r\n\r\n\r\n    return {\r\n        init: function(mailPreviewApiUrl) {\r\n            init(mailPreviewApiUrl);\r\n        }\r\n    };\r\n\r\n});"],"file":"WFEnrolMailPreview.min.js"}